{{ define "main" }}
<section class="page-hero">
  <div class="container">
    <h1>Contact Us</h1>
    <p class="hero-subtitle">Let's Talk About Your Floor</p>
  </div>
</section>

<section class="contact-section">
  <div class="container">
    <div class="contact-grid">
      <div class="contact-info">
        <h3>Get in Touch</h3>
        <p>We're here to bring your vision to life. Whether you have questions about our services, need a quote, or are ready to schedule your hardwood floor installation or refinishing, our team is just a message away.</p>

        <div class="contact-details">
          <div class="contact-item">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            <div>
              <strong>Phone</strong><br>
              <a href="tel:{{ .Site.Params.phoneTel }}">{{ .Site.Params.phoneFormatted }}</a>
            </div>
          </div>

          <div class="contact-item">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <div>
              <strong>Location</strong><br>
              {{ .Site.Params.location }}
            </div>
          </div>

          <div class="service-area-callout">
            <h4 class="service-area-callout-heading">
              <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Service Area &amp; Estimates
            </h4>
            <div class="service-area-tier">
              <span class="service-area-badge service-area-badge--free">Free</span>
              <div>
                <strong>Helena area</strong>
                <p>Free on-site estimates</p>
              </div>
            </div>
            <div class="service-area-tier">
              <span class="service-area-badge service-area-badge--deposit">Deposit</span>
              <div>
                <strong>Butte, Bozeman &amp; beyond</strong>
                <p>Site visit deposit &mdash; credited to your project</p>
              </div>
            </div>
          </div>

          <div class="contact-item">
            <a href="https://www.bbb.org/us/mt/helena/profile/hardwood-floor-contractors/traver-hardwood-floors-llc-1296-1000188524/#sealclick"
               target="_blank"
               rel="nofollow">
              <img
                src="https://seal-alaskaoregonwesternwashington.bbb.org/seals/darkgray-seal-293-61-bbb-1000188524.png"
                alt="Traver Hardwood Floors LLC BBB Business Review"
                width="293"
                height="61"
                loading="lazy" />
            </a>
          </div>
        </div>
      </div>

      <div class="contact-form">
        <h3>Request an Estimate</h3>

        <div id="form-success" class="form-message form-message-success" role="alert" style="display: none;">
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <div>
            <strong>Estimate Request Received!</strong>
            <p>Thank you! We'll be in touch soon to schedule your estimate.</p>
          </div>
        </div>

        <div id="form-error" class="form-message form-message-error" role="alert" style="display: none;">
          <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <div>
            <strong>Something went wrong</strong>
            <p id="error-message">Please try again or call us directly.</p>
          </div>
        </div>

        <form id="contact-form">
          <p style="display: none;">
            <label>Don't fill this out if you're human: <input name="bot-field" id="bot-field"></label>
          </p>

          <div class="form-group">
            <label for="name">Name *</label>
            <input type="text" id="name" name="name" required minlength="1" maxlength="50">
          </div>

          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" name="email" required maxlength="50">
          </div>

          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" name="phone" maxlength="50">
          </div>

          <div class="form-group">
            <label for="city">City / Town *</label>
            <input type="text" id="city" name="city" required maxlength="100" placeholder="e.g., Helena, Bozeman, Big Sky">
          </div>

          <div class="form-group">
            <label for="projectType">Project Type</label>
            <select id="projectType" name="projectType">
              <option value="">Select a project type...</option>
              <option value="installation">Installation</option>
              <option value="refinishing">Sanding & Refinishing</option>
              <option value="repair">Repair & Restoration</option>
              <option value="stairs">Stairs</option>
              <option value="other">Other / Not Sure</option>
            </select>
          </div>

          <div class="form-group">
            <label for="squareFootage">Approximate Square Footage</label>
            <input type="text" id="squareFootage" name="squareFootage" maxlength="20" placeholder="e.g., 500, 1200">
          </div>

          <div class="form-group">
            <label for="message">Tell Us About Your Project *</label>
            <textarea id="message" name="message" required minlength="40" maxlength="1000" placeholder="Describe your floors, what you'd like done, and any details that would help us understand your project..."></textarea>
          </div>

          <div class="form-group">
            <label>Photos <span class="form-help-text">(optional, up to 5)</span></label>
            <input type="file" id="photo-input" accept="image/*" multiple style="display:none;">
            <div class="photo-upload-area">
              <button type="button" id="photo-btn" class="btn btn-secondary">Choose Photos</button>
              <span class="photo-upload-hint">JPEG, PNG, or WebP &mdash; max 2 MB each</span>
            </div>
            <div id="photo-previews" class="photo-previews"></div>
          </div>

          <div class="form-group">
            <div class="cf-turnstile" data-sitekey="{{ site.Params.turnstileSiteKey }}" data-callback="onTurnstileSuccess"></div>
          </div>

          <button type="submit" id="submit-btn" class="btn btn-primary btn-submit">Submit Estimate Request</button>
        </form>
      </div>
    </div>
  </div>
</section>
{{ end }}

{{ define "scripts" }}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
  const API_URL = '/api/estimate';
  let turnstileToken = '';
  let resizedPhotos = []; // {blob, name, url}

  function onTurnstileSuccess(token) {
    turnstileToken = token;
  }

  // Resize image using Canvas API
  function resizeImage(file, maxDim, quality) {
    maxDim = maxDim || 1600;
    quality = quality || 0.8;
    return new Promise(function(resolve) {
      var img = new Image();
      img.onload = function() {
        var w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
          else { w = Math.round(w * maxDim / h); h = maxDim; }
        }
        var canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(function(blob) { resolve(blob); }, 'image/jpeg', quality);
      };
      img.src = URL.createObjectURL(file);
    });
  }

  function renderPreviews() {
    var container = document.getElementById('photo-previews');
    container.innerHTML = '';
    resizedPhotos.forEach(function(p, i) {
      var div = document.createElement('div');
      div.className = 'photo-preview';
      div.innerHTML = '<img src="' + p.url + '" alt="Photo preview">' +
        '<button type="button" class="photo-remove" data-index="' + i + '" aria-label="Remove photo">&times;</button>';
      container.appendChild(div);
    });
    var btn = document.getElementById('photo-btn');
    btn.textContent = resizedPhotos.length > 0
      ? 'Choose Photos (' + resizedPhotos.length + '/5)'
      : 'Choose Photos';
  }

  // Photo button triggers file input
  document.getElementById('photo-btn').addEventListener('click', function() {
    document.getElementById('photo-input').click();
  });

  // File input change handler
  document.getElementById('photo-input').addEventListener('change', async function(e) {
    var files = Array.from(e.target.files);
    var remaining = 5 - resizedPhotos.length;
    if (remaining <= 0) return;
    files = files.slice(0, remaining);

    for (var i = 0; i < files.length; i++) {
      var blob = await resizeImage(files[i]);
      resizedPhotos.push({
        blob: blob,
        name: files[i].name.replace(/\.[^.]+$/, '.jpg'),
        url: URL.createObjectURL(blob)
      });
    }
    renderPreviews();
    // Reset file input so same file can be re-selected
    e.target.value = '';
  });

  // Remove photo via event delegation
  document.getElementById('photo-previews').addEventListener('click', function(e) {
    var btn = e.target.closest('.photo-remove');
    if (!btn) return;
    var idx = parseInt(btn.dataset.index, 10);
    URL.revokeObjectURL(resizedPhotos[idx].url);
    resizedPhotos.splice(idx, 1);
    renderPreviews();
  });

  // Form submit
  document.getElementById('contact-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    var form = e.target;
    var submitBtn = document.getElementById('submit-btn');
    var successMsg = document.getElementById('form-success');
    var errorMsg = document.getElementById('form-error');
    var errorText = document.getElementById('error-message');

    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';

    if (!turnstileToken) {
      errorText.textContent = 'Please complete the security check.';
      errorMsg.style.display = 'flex';
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    var fd = new FormData();
    fd.append('name', document.getElementById('name').value);
    fd.append('email', document.getElementById('email').value);
    fd.append('phone', document.getElementById('phone').value);
    fd.append('city', document.getElementById('city').value);
    fd.append('projectType', document.getElementById('projectType').value);
    fd.append('squareFootage', document.getElementById('squareFootage').value);
    fd.append('message', document.getElementById('message').value);
    fd.append('botField', document.getElementById('bot-field').value);
    fd.append('turnstileToken', turnstileToken);

    resizedPhotos.forEach(function(p) {
      fd.append('photos', p.blob, p.name);
    });

    try {
      var response = await fetch(API_URL, {
        method: 'POST',
        body: fd
      });

      if (response.ok) {
        successMsg.style.display = 'flex';
        form.reset();
        form.style.display = 'none';
        // Clean up preview URLs
        resizedPhotos.forEach(function(p) { URL.revokeObjectURL(p.url); });
        resizedPhotos = [];
        renderPreviews();
      } else {
        var text = await response.text();
        errorText.textContent = text || 'Please try again or call us directly.';
        errorMsg.style.display = 'flex';
        if (typeof turnstile !== 'undefined') {
          turnstile.reset();
          turnstileToken = '';
        }
      }
    } catch (error) {
      errorText.textContent = 'Network error. Please try again or call us directly.';
      errorMsg.style.display = 'flex';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Estimate Request';
    }
  });
</script>
{{ end }}
